generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  shevet            String?
  role              String?
  emailVerified     DateTime?
  resetToken        String?
  resetTokenExpires DateTime?
  leaguesOwned      League[]  @relation("LeagueOwner")
  teams             Team[]
}

model League {
  id         String         @id @default(cuid())
  name       String
  inviteCode String?        @unique
  ownerId    String?
  type       String?
  shevet     String?
  role       String?
  owner      User?          @relation("LeagueOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  members    LeagueMember[]
  teams      Team[]
}

model LeagueMember {
  id       String  @id @default(cuid())
  leagueId String
  role     String?
  teamId   String
  league   League  @relation(fields: [leagueId], references: [id])
  team     Team    @relation(fields: [teamId], references: [id])

  @@unique([leagueId, teamId])
}

model Team {
  id             String          @id @default(cuid())
  name           String
  userId         String
  leagueId       String?
  budget         Float           @default(34)
  gameweekScores GameweekScore[]
  memberships    LeagueMember[]
  slots          SquadSlot[]
  league         League?         @relation(fields: [leagueId], references: [id], onDelete: Restrict)
  user           User            @relation(fields: [userId], references: [id])

  @@unique([userId, leagueId])
}

model Player {
  id           String         @id @default(cuid())
  name         String
  teamName     String
  position     Position
  price        Float
  status       PlayerStatus
  ownedPct     Float?
  nextFixture  String?
  totalPoints  Int?
  roundPoints  Int?
  goals        Int?
  assists      Int?
  cleanSheets  Int?
  playerPoints PlayerPoints[]
  events       ScoreEvent[]
  slots        SquadSlot[]

  @@unique([name, teamName])
}

model SquadSlot {
  id        String  @id @default(cuid())
  teamId    String
  playerId  String?
  slotLabel String
  isCaptain Boolean @default(false)
  isVice    Boolean @default(false)
  player    Player? @relation(fields: [playerId], references: [id])
  team      Team    @relation(fields: [teamId], references: [id])

  @@unique([teamId, slotLabel])
}

model Gameweek {
  id           Int             @id @default(autoincrement())
  number       Int             @unique
  name         String?
  startsAt     DateTime
  deadlineAt   DateTime
  isCurrent    Boolean         @default(false)
  isFinished   Boolean         @default(false)
  fixtures     Fixture[]
  scores       GameweekScore[]
  playerPoints PlayerPoints[]
}

model Fixture {
  id         String       @id @default(cuid())
  homeTeam   String
  awayTeam   String
  kickoffAt  DateTime
  gameweekId Int
  homeGoals  Int?
  awayGoals  Int?
  gameweek   Gameweek     @relation(fields: [gameweekId], references: [id])
  events     ScoreEvent[]
}

model ScoreEvent {
  id        String     @id @default(cuid())
  fixtureId String
  playerId  String
  type      EventType
  minute    Int?
  fixture   Fixture    @relation(fields: [fixtureId], references: [id])
  player    Player     @relation(fields: [playerId], references: [id])
}

model GameweekScore {
  id         String   @id @default(cuid())
  teamId     String
  total      Int
  gameweekId Int
  gameweek   Gameweek @relation(fields: [gameweekId], references: [id])
  team       Team     @relation(fields: [teamId], references: [id])

  @@unique([teamId, gameweekId])
}

model PlayerPoints {
  id            Int      @id @default(autoincrement())
  playerId      String
  gameweekId    Int
  points        Int      @default(0)
  goals         Int      @default(0)
  assists       Int      @default(0)
  ownGoals      Int      @default(0)
  yellowCards   Int      @default(0)
  redCards      Int      @default(0)
  goalsConceded Int      @default(0)
  gameweek      Gameweek @relation(fields: [gameweekId], references: [id])
  player        Player   @relation(fields: [playerId], references: [id])

  @@unique([playerId, gameweekId])
}

model GlobalSettings {
  id            Int     @id @default(1)
  transfersOpen Boolean @default(true)
}

/// *
///  * ---------- ENUMS ----------
enum Position {
  GK
  OUT
}

enum PlayerStatus {
  A
  I
}

enum EventType {
  GOAL
  ASSIST
  YC
  RC
  OG
}
